<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head><meta charset="utf-8"><title>Admin</title></head>
<body>
<div th:replace="layout :: nav"></div>

<h1>Admin – Products</h1>

<section>
  <h3>Create Product</h3>
  <form id="createForm">
    <input placeholder="Name" id="name" required>
    <input placeholder="Description" id="desc" required>
    <input placeholder="Price" id="price" type="number" step="0.01" required>
    <input placeholder="SKU" id="sku" required>
    <input placeholder="Stock" id="stock" type="number" required>
    <input placeholder="Image URL" id="img">
    <input placeholder="Category ID" id="cat" type="number" required>
    <button type="submit">Create</button>
  </form>
</section>

<section>
  <h3>All Products</h3>
  <ul id="list"></ul>
</section>

<script>
  (async function () {
    const t = localStorage.getItem('token');
    if (!t) { alert('Login as ADMIN first'); location.href='/login'; return; }
    const auth = { Authorization: `Bearer ${t}`, 'Content-Type':'application/json' };

    async function load() {
      const res = await fetch('/api/admin/products', { headers: auth });
      const ul = document.getElementById('list');
      ul.innerHTML = '';
      if (!res.ok) { ul.textContent = 'Forbidden'; return; }
      const arr = await res.json();
      if (!arr.length) { ul.textContent = 'No products available.'; return; }
      arr.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `#${p.id} ${p.name} (${p.sku}) – ${p.price} • active=${p.active}`;
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.onclick = async () => {
          const r = await fetch('/api/admin/products/' + p.id, { method:'DELETE', headers:auth });
          if (r.ok || r.status === 204) load(); else alert('Delete failed');
        };
        const tog = document.createElement('button');
        tog.textContent = 'Toggle Active';
        tog.onclick = async () => {
          const r = await fetch(`/api/admin/products/${p.id}/active?active=${!p.active}`, { method:'PATCH', headers:auth });
          if (r.ok || r.status === 204) load(); else alert('Toggle failed');
        };
        li.append(' ', del, ' ', tog);
        ul.appendChild(li);
      });
    }

    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const body = {
        name:        document.getElementById('name').value.trim(),
        description: document.getElementById('desc').value.trim(),
        price:       Number(document.getElementById('price').value),
        sku:         document.getElementById('sku').value.trim(),
        stock:       Number(document.getElementById('stock').value),
        imageUrl:    document.getElementById('img').value.trim(),
        categoryId:  Number(document.getElementById('cat').value)
      };
      const r = await fetch('/api/admin/products', { method:'POST', headers:auth, body: JSON.stringify(body) });
      if (r.ok || r.status === 201) { e.target.reset(); load(); }
      else { alert('Create failed'); console.error(await r.text()); }
    });

    load();
  })();
</script>
</body>
</html>
