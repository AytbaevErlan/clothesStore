<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head><meta charset="utf-8"><title>Admin</title></head>
<body>
<div th:replace="layout :: nav"></div>

<h1>Admin – Products</h1>

<section>
  <h3>Create Product</h3>
  <form id="createForm">
    <input placeholder="Name" id="name" required>
    <input placeholder="Description" id="desc" required>
    <input placeholder="Price" id="price" type="number" step="0.01" required>
    <input placeholder="SKU" id="sku" required>
    <input placeholder="Stock" id="stock" type="number" required>
    <input placeholder="Image URL" id="img">
    <input placeholder="Category ID" id="cat" type="number" required>
    <button type="submit">Create</button>
  </form>
</section>

<section>
  <h3>All Products</h3>
  <ul id="list"></ul>
</section>

<script>
  (async function () {
    const t = localStorage.getItem('token');
    if (!t) { alert('Login as ADMIN first'); location.href='/login'; return; }

    const auth = { Authorization: `Bearer ${t}`, 'Content-Type':'application/json' };

    async function load() {
      const res = await fetch('/api/admin/products', { headers: auth });
      if (!res.ok) { alert('403? Need ADMIN token.'); return; }
      const arr = await res.json();
      const ul = document.getElementById('list'); ul.innerHTML = '';
      arr.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `#${p.id} ${p.name} (${p.sku}) – ${p.price}
        <button data-id="${p.id}" class="del">Delete</button>`;
        ul.appendChild(li);
      });
      // delete handlers
      ul.querySelectorAll('.del').forEach(b => b.onclick = async () => {
        const id = b.getAttribute('data-id');
        const r = await fetch('/api/admin/products/'+id, { method:'DELETE', headers: auth });
        if (r.ok) load(); else alert('Delete failed');
      });
    }

    document.getElementById('createForm').onsubmit = async (e) => {
      e.preventDefault();
      const body = {
        name:        document.getElementById('name').value.trim(),
        description: document.getElementById('desc').value.trim(),
        price:       Number(document.getElementById('price').value),
        sku:         document.getElementById('sku').value.trim(),
        stock:       Number(document.getElementById('stock').value),
        imageUrl:    document.getElementById('img').value.trim(),
        categoryId:  Number(document.getElementById('cat').value)
      };
      const r = await fetch('/api/admin/products', { method:'POST', headers: auth, body: JSON.stringify(body) });
      if (r.ok || r.status === 201) { e.target.reset(); load(); }
      else { alert('Create failed'); console.error(await r.text()); }
    };

    load();
  })();
</script>
</body>
</html>
