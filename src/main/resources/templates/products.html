<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head><meta charset="utf-8"><title>Products</title></head>
<body>
<div th:replace="layout :: nav"></div>

<h1>Products</h1>

<form method="get" action="/products">
    <label>Search</label>
    <input type="text" name="q" th:value="${q}">
    <button type="submit">Search</button>
</form>

<div th:if="${#lists.isEmpty(products)}">No items.</div>

<div th:each="p : ${products}">
    <article>
        <img th:if="${p.imageUrl}" th:src="${p.imageUrl}" alt="img" style="height:120px"/>
        <h3 th:text="${p.name}">name</h3>
        <p th:text="${p.categoryName}">category</p>
        <strong th:text="${p.price}">0.00</strong>
        <p>
            <span th:text="${p.categoryName}"></span>
            <span> â€¢ </span>
            <span th:text="'Stock: ' + ${p.stock}"></span>
        </p>
        <button type="button" class="add" th:disabled="${p.stock == 0}" th:attr="data-id=${p.id}">Add to cart</button>
    </article>
    <hr/>
</div>

<div>
    <a th:if="${!pg.first}" th:href="@{/products(page=${pg.number-1},size=${pg.size},q=${q})}">Prev</a>
    <span th:text="${pg.number+1}"></span>/<span th:text="${pg.totalPages}"></span>
    <a th:if="${!pg.last}" th:href="@{/products(page=${pg.number+1},size=${pg.size},q=${q})}">Next</a>
</div>

<script>
    function isBuyer(){
        try{
            const t = localStorage.getItem('token');
            if(!t) return false;
            const payload = JSON.parse(atob(t.split('.')[1]));
            const roles = payload.roles || [];
            return roles.includes('ROLE_BUYER');
        }catch{ return false; }
    }

    // Hide Add buttons for non-buyers
    (function guardButtons(){
        const buyer = isBuyer();
        document.querySelectorAll('button.add').forEach(b=>{
            if(!buyer){
                b.disabled = true;
                b.title = 'Login as Buyer to purchase';
                b.style.opacity = '0.5';
            }
        });
    })();

    document.addEventListener('click', async (e) => {
        if (!e.target.classList.contains('add')) return;

        if(!isBuyer()){
            alert('Only BUYER accounts can add items to cart.');
            return;
        }

        const id = e.target.getAttribute('data-id');
        const t  = localStorage.getItem('token');
        if (!t) { alert('Login first'); location.href='/login'; return; }

        try {
            const res = await fetch(`/api/cart/add/${id}?qty=1`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${t}` }
            });
            if (!res.ok) throw new Error(await res.text());
            alert('Added');
        } catch (err) {
            console.error(err);
            alert('Failed');
        }
    });
</script>
<script>
    (function(){
        const t = localStorage.getItem('token');
        let isBuyer = false;
        try { isBuyer = t && JSON.parse(atob(t.split('.')[1])).roles.includes('ROLE_BUYER'); } catch {}
        document.querySelectorAll('button.add').forEach(b => b.style.display = isBuyer ? '' : 'none');
    })();
</script>



</body>
</html>
